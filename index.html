<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSL AI: Interpolated & Debuggable</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@latest/dist/tf-backend-wasm.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { background: #111; color: white; font-family: monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        #container { position: relative; width: 100%; max-width: 640px; aspect-ratio: 4/3; background: #000; border: 2px solid #333; border-radius: 8px; overflow: hidden; }
        
        #videoElement { display: none; }
        #canvasElement { width: 100%; height: 100%; transform: scaleX(-1); }

        /* HUD */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; }
        
        .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #0f0; text-shadow: 1px 1px 0 #000; }
        #debug-info { background: rgba(0,0,0,0.7); padding: 5px; border-radius: 4px; pointer-events: auto; }
        
        #status-msg { font-size: 32px; font-weight: bold; text-align: center; text-shadow: 0 0 10px #000; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; }

        #controls { padding: 10px; width: 100%; max-width: 640px; display: flex; gap: 10px; justify-content: center; }
        
        button { background: #333; color: white; border: 1px solid #555; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-family: monospace; }
        button:active { background: #555; }
        #swap-btn { background: #444; border-color: #0f0; color: #0f0; }

        #prediction-box { background: #222; width: 95%; max-width: 640px; padding: 15px; margin-top: 10px; border-radius: 6px; text-align: center; border: 1px solid #444; }
        #sentence { color: #fff; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="container">
        <video id="videoElement" playsinline></video>
        <canvas id="canvasElement"></canvas>
        
        <div id="ui-layer">
            <div class="stat-row">
                <span>FPS: <span id="fps-val">0</span></span>
                <span>Buffer: <span id="buffer-val">0</span>/60</span>
            </div>
            <div id="status-msg">LOADING...</div>
            <div style="text-align: right;">
                <div id="debug-info">
                    Detected: <span id="hand-side">-</span><br>
                    Conf: <span id="conf-val">0.00</span>
                </div>
            </div>
        </div>
    </div>

    <div id="controls">
        <button id="swap-btn" onclick="toggleSwap()">üîÑ SWAP L/R (Normal)</button>
        <button onclick="window.location.reload()">‚ö†Ô∏è Reset</button>
    </div>

    <div id="prediction-box">
        SENTENCE: <span id="sentence">...</span>
    </div>

    <script>
        const CONFIG = {
            SEQUENCE_LENGTH: 60,
            TARGET_FPS: 30, // The FPS your model was trained on
            THRESHOLD: 0.8,
            USE_WASM: true
        };

        // UI Elements
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');
        const statusMsg = document.getElementById('status-msg');
        const sentSpan = document.getElementById('sentence');
        const fpsVal = document.getElementById('fps-val');
        const bufVal = document.getElementById('buffer-val');
        const handSideSpan = document.getElementById('hand-side');
        const confVal = document.getElementById('conf-val');
        const swapBtn = document.getElementById('swap-btn');

        // State
        let model, hands;
        let labels = [];
        let sequence = [];
        let sentence = [];
        let isSwapMode = false; // Toggle for mirroring fix
        let lastFrameTime = 0;
        let isProcessing = false;

        // --- 1. SETUP ---
        async function init() {
            try {
                if(CONFIG.USE_WASM) {
                    tf.wasm.setWasmPaths('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@latest/dist/');
                    await tf.setBackend('wasm');
                } else {
                    await tf.setBackend('webgl');
                }
                
                statusMsg.innerText = "LOADING MODEL...";
                model = await tf.loadLayersModel('model/model.json');
                
                // Warmup
                model.predict(tf.zeros([1, 60, 126])).dispose();

                const lblRes = await fetch('js/labels.json');
                labels = await lblRes.json();

                setupMediaPipe();
            } catch (e) {
                console.error(e);
                statusMsg.innerText = "ERROR: " + e.message;
            }
        }

        function setupMediaPipe() {
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 0, // Lite mode
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            hands.onResults(onResults);
            startCamera();
        }

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                statusMsg.innerText = "";
                loop();
            };
        }

        // --- 2. LOOP & INTERPOLATION ---
        function loop() {
            // Draw Video immediately (smooth UI)
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Only trigger AI if not busy
            if (!isProcessing) {
                isProcessing = true;
                hands.send({image: video}).then(() => {
                    isProcessing = false;
                });
            }
            requestAnimationFrame(loop);
        }

        function onResults(results) {
            const now = performance.now();
            const delta = now - lastFrameTime;
            lastFrameTime = now;
            
            // Calculate FPS
            fpsVal.innerText = Math.round(1000 / delta);

            // 1. Draw Landmarks
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                    drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 1});
                }
            }
            ctx.restore();

            // 2. Extract Data
            const keypoints = extractKeypoints(results);

            // 3. SMART INTERPOLATION (The Fix)
            // If phone is slow (e.g. 15fps), delta is 66ms.
            // Target is 30fps (33ms).
            // We need to push the SAME frame multiple times to fill the time gap.
            const framesToGen = Math.max(1, Math.round(delta / (1000 / CONFIG.TARGET_FPS)));
            
            for(let i=0; i < framesToGen; i++) {
                sequence.push(keypoints);
                if (sequence.length > CONFIG.SEQUENCE_LENGTH) sequence.shift();
            }
            
            bufVal.innerText = sequence.length;

            // 4. Predict
            if (sequence.length === CONFIG.SEQUENCE_LENGTH) {
                tf.tidy(() => {
                    const input = tf.tensor3d([sequence]);
                    const pred = model.predict(input);
                    const values = pred.dataSync();
                    const maxVal = Math.max(...values);
                    const idx = values.indexOf(maxVal);
                    
                    confVal.innerText = maxVal.toFixed(2);
                    
                    if (maxVal > CONFIG.THRESHOLD) {
                        const label = labels[idx];
                        statusMsg.innerText = label;
                        updateSentence(label);
                    } else {
                        statusMsg.innerText = "...";
                    }
                });
            }
        }

        // --- 3. KEYPOINT MAPPING & SWAP ---
        function extractKeypoints(results) {
            let lh = new Array(63).fill(0);
            let rh = new Array(63).fill(0);
            let debugSide = "None";

            if (results.multiHandLandmarks && results.multiHandedness) {
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    let label = results.multiHandedness[i].label; // "Left" or "Right"
                    
                    // Toggle Swap Logic
                    if (isSwapMode) {
                        label = (label === "Left") ? "Right" : "Left";
                    }
                    debugSide = label;

                    const lm = results.multiHandLandmarks[i];
                    const flat = [];
                    for (const p of lm) flat.push(p.x, p.y, p.z);

                    if (label === "Left") lh = flat;
                    else rh = flat;
                }
            }
            
            handSideSpan.innerText = debugSide;
            return [...lh, ...rh];
        }

        // --- 4. HELPERS ---
        function toggleSwap() {
            isSwapMode = !isSwapMode;
            swapBtn.innerText = isSwapMode ? "üîÑ SWAP L/R (Swapped)" : "üîÑ SWAP L/R (Normal)";
            swapBtn.style.borderColor = isSwapMode ? "#ff0" : "#0f0";
            swapBtn.style.color = isSwapMode ? "#ff0" : "#0f0";
        }

        function updateSentence(word) {
            if (sentence.length === 0 || word !== sentence[sentence.length-1]) {
                sentence.push(word);
                if (sentence.length > 5) sentence.shift();
                sentSpan.innerText = sentence.join(" ");
            }
        }

        // Init
        init();

    </script>
</body>
</html>